import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

# ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุงูุชุฃูุฏ ูู ุงููุณุงุฑ ุงูุตุญูุญ
file_path = "Riyadh_Aqqar.xlsx"

# ูุฑุงุกุฉ ุงูุจูุงูุงุช ูู ุงูุชุจููุจุงุช ุงูุตุญูุญุฉ
df_villas = pd.read_excel(file_path, sheet_name="Villas (ุงูููู)")
df_apartments = pd.read_excel(file_path, sheet_name="Apartments (ุงูุดูู)")

# ุชูุธูู ุฃุณูุงุก ุงูุฃุนูุฏุฉ ูู ุฃู ูุณุงูุงุช ุฒุงุฆุฏุฉ
df_villas.columns = df_villas.columns.str.strip()
df_apartments.columns = df_apartments.columns.str.strip()

# ุงูุชุฃูุฏ ูู ุฃู ุงูุฃุนูุฏุฉ ุงููููุฉ ููุฌูุฏุฉ ูุฅูุง ูุชู ุนุฑุถ ุฎุทุฃ
required_columns = ["ุนุฏุฏ ุงูุบุฑู", "ุงููุณุงุญุฉ", "ุงูุณุนุฑ ุงูุฅุฌูุงูู", "ุงูุณุนุฑ ุงููุฑุจุน"]
for col in required_columns:
    if col not in df_villas.columns or col not in df_apartments.columns:
        st.error(f"โ ุงูุนููุฏ '{col}' ุบูุฑ ููุฌูุฏ ูู ุงูุจูุงูุงุชุ ุชุญูู ูู ุงูุงุณู ุงูุตุญูุญ!")
        st.stop()

# ุชุญููู ุงูููู ุงููุตูุฉ ุฅูู ุฃุฑูุงู ูุงูุชุนุงูู ูุน ุงูููู ุงูููููุฏุฉ
for col in ["ุนุฏุฏ ุงูุบุฑู", "ุงููุณุงุญุฉ", "ุงูุณุนุฑ ุงูุฅุฌูุงูู", "ุงูุณุนุฑ ุงููุฑุจุน"]:
    df_villas[col] = pd.to_numeric(df_villas[col], errors="coerce")
    df_apartments[col] = pd.to_numeric(df_apartments[col], errors="coerce")

# ุฅุฒุงูุฉ ุงูููู ุงููุงุฑุบุฉ ุจุนุฏ ุงูุชุญููู
df_villas.dropna(subset=required_columns, inplace=True)
df_apartments.dropna(subset=required_columns, inplace=True)

# ------------------------- ูุงุฌูุฉ Streamlit -------------------------

# ุนููุงู ุงูุชุทุจูู
st.title("๐ก ุจูุช ุงูุฌุฏุฉ โ ุงุฎุชูุงุฑ ุงูููุฒู ุงููุซุงูู ููุนุงุฆูุฉ ุงูุณุนูุฏูุฉ")
st.write("### ุชุฌูุนุงุช ุงูุนุงุฆูุฉ ูุง ุชูุชูู ุฅูุง ูู ุจูุช ุงูุฌุฏุฉ! โจ")
st.write("ุฎูููุง ููุชุดู ูุนูุง ูู ุนุฏุฏ ุงูุบุฑู ุงูุชู ูุญุชุงุฌูุงุ ููุง ูู ุงููุณุงุญุฉ ุงูููุงุณุจุฉุ")

# ุงุฎุชูุงุฑ ููุน ุงูุนูุงุฑ (ูููุง ุฃู ุดูุฉ)
property_type = st.radio("ุงุฎุชุฑ ููุน ุงูุนูุงุฑ:", ["ูููุง", "ุดูุฉ"])

# ุชุญุฏูุฏ ุจูุงูุงุช ุงูุนูุงุฑ ุงููุฎุชุงุฑุฉ
df_selected = df_villas if property_type == "ูููุง" else df_apartments

# ุงุฎุชูุงุฑ ุนุฏุฏ ุงูุบุฑู
num_rooms = st.slider("ูู ุนุฏุฏ ุงูุบุฑู ุงูุชู ุชุญุชุงุฌูุงุ", min_value=3, max_value=10, value=5)
st.write(f"๐น ุงุฎุชุฑุช {num_rooms} ุบุฑู!")

# ุงุฎุชูุงุฑ ูุณุงุญุฉ ุงูุจูุช
space_options = {
    "ุตุบูุฑุฉ (300-400ูยฒ)": (300, 400),
    "ูุชูุณุทุฉ (400-600ูยฒ)": (400, 600),
    "ูุจูุฑุฉ (600-1000ูยฒ)": (600, 1000),
}
selected_space = st.selectbox("ูุง ูู ุงููุณุงุญุฉ ุงูููุงุณุจุฉุ", list(space_options.keys()))
space_range = space_options[selected_space]
st.write(f"๐น ุงุฎุชุฑุช {selected_space}!")

# ุชุตููุฉ ุงูุจูุงูุงุช ุจูุงุกู ุนูู ุงูุงุฎุชูุงุฑุงุช
df_filtered = df_selected[
    (df_selected["ุนุฏุฏ ุงูุบุฑู"] >= num_rooms) & 
    (df_selected["ุงููุณุงุญุฉ"].between(space_range[0], space_range[1]))
]

# ุนุฑุถ ุนุฏุฏ ุงูููุงุฒู ุงููุชุงุญุฉ
st.write("### ๐ ุงูููุงุฒู ุงููุชุงุญุฉ ุจูุฐู ุงูููุงุตูุงุช:")
st.write(f"ุชู ุงูุนุซูุฑ ุนูู {df_filtered.shape[0]} ููุฒููุง ูุชุทุงุจู ูุน ุงุฎุชูุงุฑุงุชู!")

# ---------------------- ุงููุฎุทุทุงุช ุงูุจูุงููุฉ ----------------------

# ุฑุณู ุชูุฒูุน ุนุฏุฏ ุงูุบุฑู
fig, ax = plt.subplots(figsize=(8, 5))
sns.countplot(data=df_filtered, x="ุนุฏุฏ ุงูุบุฑู", palette="Blues")
plt.title("ุชูุฒูุน ุนุฏุฏ ุงูุบุฑู ูู ุงูููุงุฒู ุงููุชุงุญุฉ")
plt.xlabel("ุนุฏุฏ ุงูุบุฑู")
plt.ylabel("ุนุฏุฏ ุงูููุงุฒู")
st.pyplot(fig)

# ุฑุณู ุชูุฒูุน ุงููุณุงุญุงุช
fig2, ax2 = plt.subplots(figsize=(8, 5))
sns.histplot(df_filtered["ุงููุณุงุญุฉ"], bins=30, kde=True, color="blue")
plt.title("ุชูุฒูุน ุงููุณุงุญุงุช ูู ุงูููุงุฒู ุงููุชุงุญุฉ")
plt.xlabel("ุงููุณุงุญุฉ (ูยฒ)")
plt.ylabel("ุนุฏุฏ ุงูููุงุฒู")
st.pyplot(fig2)

# ---------------------- ุนุฑุถ ุจูุงูุงุช ุงูููุงุฒู ----------------------

# ุนุฑุถ ุฌุฏูู ุงูููุงุฒู ุงููุชุงุญุฉ
st.write("### ๐ก ุชูุงุตูู ุงูููุงุฒู ุงููุชุงุญุฉ:")
st.dataframe(df_filtered[["ุนุฏุฏ ุงูุบุฑู", "ุงููุณุงุญุฉ", "ุงูุณุนุฑ ุงูุฅุฌูุงูู", "ุงูุณุนุฑ ุงููุฑุจุน"]].sort_values(by="ุงูุณุนุฑ ุงูุฅุฌูุงูู"))

# ---------------------- ุฑุณุงูุฉ ุฎุชุงููุฉ ----------------------
st.success("๐ ุงุณุชูุชุน ุจุชุญููู ุงูุจูุงูุงุช ูุงุฎุชูุงุฑ ุจูุช ุงูุฌุฏุฉ ุงููุซุงูู! ูุง ุชูุณู ุฃู ุชุดุงุฑููุง ุฐูุฑูุงุชู ุงูุฌูููุฉ ุนู ุจูุช ุงูุฌุฏุฉ ๐ตโค๏ธ")
